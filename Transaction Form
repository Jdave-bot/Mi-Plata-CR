import React from 'react';
import { useApp } from '@/Layout';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Calendar } from "@/components/ui/calendar";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { format } from "date-fns";
import { es, enUS } from "date-fns/locale";
import { Calendar as CalendarIcon, Loader2 } from "lucide-react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Sparkles, ArrowRight } from "lucide-react";

export default function TransactionForm({ isOpen, onOpenChange }) {
    const { t, language, formatMoney } = useApp();
    const queryClient = useQueryClient();
    
    // --- Automation Logic State ---
    const [suggestion, setSuggestion] = React.useState(null); // For Savings Suggestion Modal
    
    // Fetch Rules
    const { data: catRules = [] } = useQuery({
        queryKey: ['catRules'],
        queryFn: () => base44.entities.CategorizationRule.list(),
        enabled: isOpen // Only fetch when form is open
    });

    const { data: savingsRules = [] } = useQuery({
        queryKey: ['savingsRules'],
        queryFn: () => base44.entities.SavingsRule.filter({ is_active: true }),
        enabled: isOpen
    });
    
    const { data: goals = [] } = useQuery({
        queryKey: ['goals'],
        queryFn: () => base44.entities.Goal.list(),
        enabled: isOpen
    });

    const [formData, setFormData] = React.useState({
        amount: '',
        type: 'expense',
        category: 'Food',
        description: '',
        date: new Date()
    });

    const categories = {
        expense: ['Food', 'Transport', 'Housing', 'Entertainment', 'Health', 'Other'],
        income: ['Salary', 'Freelance', 'Investment', 'Gift', 'Other']
    };

    // Translations for categories
    const catTrans = {
        Food: { es: "Comida", en: "Food" },
        Transport: { es: "Transporte", en: "Transport" },
        Housing: { es: "Vivienda", en: "Housing" },
        Entertainment: { es: "Entretenimiento", en: "Entertainment" },
        Health: { es: "Salud", en: "Health" },
        Other: { es: "Otro", en: "Other" },
        Salary: { es: "Salario", en: "Salary" },
        Freelance: { es: "Freelance", en: "Freelance" },
        Investment: { es: "InversiÃ³n", en: "Investment" },
        Gift: { es: "Regalo", en: "Gift" }
    };

    const updateGoalMutation = useMutation({
        mutationFn: ({ id, amount }) => {
            const goal = goals.find(g => g.id === id);
            return base44.entities.Goal.update(id, { current_amount: (goal?.current_amount || 0) + amount });
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['goals'] });
            setSuggestion(null);
            onOpenChange(false); // Close main modal too if we want
        }
    });

    const checkSavingsRules = (txData) => {
        let bestSuggestion = null;

        for (const rule of savingsRules) {
            if (rule.rule_type === 'percentage_of_income' && txData.type === 'income') {
                const saveAmount = txData.amount * (rule.value / 100);
                if (saveAmount > 0) {
                    const goal = goals.find(g => g.id === rule.goal_id);
                    if (goal) {
                        bestSuggestion = {
 
